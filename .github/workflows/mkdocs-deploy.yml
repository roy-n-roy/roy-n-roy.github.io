name: MkDocs Test and Deploy

on: 
  push:
    # releaseブランチのdocsディレクトリ配下で
    # Markdown、画像、設定ファイルがpushされた時に実行する
    branches:
      - release
    paths:
      - 'docs/**/*.md'
      - 'docs/imgs/**'
      - 'mkdocs.yml'
      - 'pyproject.toml'
      - 'poetry.lock'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Git config
        run: |
          git config --global user.name "github-actions"
          git config --global user.email actions@github.com

      # リポジトリをチェックアウトする
      # MkDocsでgit-revision-dateプラグインを利用している場合は、
      # 全てのコミット履歴をfetchする(fetch-depth: 0)
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      # Poetryをインストールする
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python

      # Python3.8をセットアップ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'
          cache: 'poetry'

      # poetry.lockから依存関係をインストールする
      - name: Install dependencies
        run: |
          poetry install --no-root

      # MkDocsでGitHubへデプロイする
      - name: MkDocs Deploy
        env:
          GOOGLE_ANALYTICS_TRACKING_ID: ${{ secrets.GOOGLE_ANALYTICS_TRACKING_ID }}
        run: |
          git fetch --depth=1 origin master
          poetry run mkdocs gh-deploy

      # Slackへ通知する
      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,author,workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
