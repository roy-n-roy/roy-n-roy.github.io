# WSL2
Windows Subsystem for Linux(WSL)は仮想マシンのオーバーヘッドなしでGNU/Linuxの実行バイナリ(Executable and Linkable Format, ELF)を実行することのできる環境を提供する機能です。
Windows 10 バージョン1709 以降のHome/Proエディション共に利用することができます。  

2020年春ごろに公開予定のWindows 10 バージョン2004 以降では、現行のWSL(以降、バージョン1と記載) に加えて、WSL2(以降、WSL2 もしくは バージョン2と記載) を利用出来るようになります。

## WSL2の改善点
WSL2では、バージョン1と比較して、下記の改善がなされています。

* Linux上でのファイルアクセス速度の向上
* システムコールの完全互換

一方で、Linux上から、NTFSなどのWindows上のファイルへのアクセス速度は下がっているため、多くのファイルアクセスが必要な場面ではLinux側へファイルを移動させた上で処理する方が良いとされています。

これは、WSLバージョン1が「Windows上でELFバイナリを実行する」機能であったのに比べ、WSLバージョン2は「軽量仮想マシン上でLinuxコンテナを動作させる」機能であることによるものです。  

## アーキテクチャ比較
<figure style="text-align: center;">
<a href="/imgs/windows_wsl_wsl2.png" data-lightbox="windows_wsl_wsl2"><img src="/imgs/windows_wsl_wsl2.png" /></a>  
<figcaption>図. WSLとWSL2 アーキテクチャの概略</figcaption>
</figure>

### WSL1のアーキテクチャ
WSL2との比較の前に、WSL1の仕組みについて説明していきます。
#### プロセス管理
Windows上で、Linuxディストリビューションを起動するとLxssManagerの子プロセスとしてinitプロセスが立ち上がります。
Linux側でも同じくinitプロセスがプロセスID=1のプロセスとして起動され、全てのプロセスはinitプロセスの子孫として紐付けられて起動します。  
ただし、このinitプロセスはSystem V initではなく、9Pサーバの機能を有するMS製のバイナリだそうです。

また、Linux上で起動したbashなどのELFバイナリのプロセスはWindowsプロセスとして起動され、Windowsプロセスとして管理されます。ですので、Windows上のタスクマネージャなどからでも確認することができます。

#### メモリ管理
前述の通り、LinuxのバイナリがWindowsのプロセスとして動作するため、LxssManagerを通じてNTカーネル側でメモリを割り当てされているのだと思われます。

#### システムコール
WSLバージョン1では、LxssManagerというサービスがWindows上に常駐しています。
これが、Linux上ではカーネルの代替として機能します。  

LxssManagerは、ユーザランドプロセスからのシステムコールを受け付けて、Windows側のNT Kernelに流します。
ただし、一部のシステムコールは提供されていないため、iptablesなど動作しないプログラムも存在します。

#### ファイルシステム
WSLバージョン1では、ルートファイルシステムにはext4やxfsでもNTFSでもなく、`lxfs`というWSL独自のファイルシステムを使用しています。  
その実態は、「ファイルやフォルダはNTFS上に配置し、パーミッション情報などのメタデータを別途保持するもの」のようです。  
ですので、Windows上からLinuxのhomeディレクトリの内容などを参照することはできますが、編集するとメタデータに不整合が発生するため、避ける必要があります。  

一方、WSLではWindowsのCドライブなどが、初期状態でマウントされており、参照・編集することができます。  
こちらは`drvfs`というファイルシステムになっており、見た目上のパーミッションは`777`でオーナーはログインユーザ自身になっていますが、Windows上のアクセス権限とはリンクしておらず、パーミッションを変更することもできないようになっています。  

#### デバイス管理
ほとんどのデバイスは生えていませんが、COMポート(/dev/ttyS0など)やWindows側のネットワークデバイス、cpuinfoなどは見えるようです。

### WSL2のアーキテクチャ
#### プロセス管理
Windows上ではHyper-Vコンテナが起動しており